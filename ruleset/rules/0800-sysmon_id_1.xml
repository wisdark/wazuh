<!--
  -  Sysmon Event ID 1 rules
  -  Created by Wazuh, Inc.
  -  Copyright (C) 2015-2021, Wazuh Inc.
  -  This program is a free software; you can redistribute it and/or modify it under the terms of GPLv2.
-->

<group name="sysmon_eid1_detections,">

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.3643213Z","eventRecordID":"144504","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-04-28 20:11:55.352\r\nProcessGuid: {4dc16835-c18b-6089-a203-000000002e00}\r\nProcessId: 648\r\nImage: C:\\Windows\\System32\\wscript.exe\r\nFileVersion: 5.812.10240.16384\r\nDescription: Microsoft ® Windows Based Script Host\r\nProduct: Microsoft ® Windows Script Host\r\nCompany: Microsoft Corporation\r\nOriginalFileName: wscript.exe\r\nCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\" \r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C\r\nParentProcessGuid: {4dc16835-c189-6089-a003-000000002e00}\r\nParentProcessId: 6876\r\nParentImage: C:\\Windows\\System32\\cscript.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cscript.exe\" .\\drop-payloads.vbe\""},"eventdata":{"ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","utcTime":"2021-04-28 20:11:55.352","processGuid":"{4dc16835-c18b-6089-a203-000000002e00}","processId":"648","image":"C:\\\\Windows\\\\System32\\\\wscript.exe","fileVersion":"5.812.10240.16384","description":"Microsoft ® Windows Based Script Host","product":"Microsoft ® Windows Script Host","company":"Microsoft Corporation","originalFileName":"notepàd.exe","commandLine":"\\\"C:\\\\Windows\\\\System32\\\\notepad.exe\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C","parentProcessGuid":"{4dc16835-c189-6089-a003-000000002e00}","parentProcessId":"6876","parentImage":"C:\\\\Windows\\\\System32\\\\cscript.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cscript.exe\\\" .\\\\drop-payloads.vbe"}}} -->
    <rule id="92010" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\\(c|w)script\.exe</field>
        <description>Scripting interpreter spawned a new process</description>
        <mitre>
            <id>T1059.005</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.3643213Z","eventRecordID":"144504","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-04-28 20:11:55.352\r\nProcessGuid: {4dc16835-c18b-6089-a203-000000002e00}\r\nProcessId: 648\r\nImage: C:\\Windows\\System32\\wscript.exe\r\nFileVersion: 5.812.10240.16384\r\nDescription: Microsoft ® Windows Based Script Host\r\nProduct: Microsoft ® Windows Script Host\r\nCompany: Microsoft Corporation\r\nOriginalFileName: wscript.exe\r\nCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\" \r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C\r\nParentProcessGuid: {4dc16835-c189-6089-a003-000000002e00}\r\nParentProcessId: 6876\r\nParentImage: C:\\Windows\\System32\\cscript.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cscript.exe\" .\\drop-payloads.vbe\""},"eventdata":{"ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","utcTime":"2021-04-28 20:11:55.352","processGuid":"{4dc16835-c18b-6089-a203-000000002e00}","processId":"648","image":"C:\\\\Windows\\\\System32\\\\wscript.exe","fileVersion":"5.812.10240.16384","description":"Microsoft ® Windows Based Script Host","product":"Microsoft ® Windows Script Host","company":"Microsoft Corporation","originalFileName":"wscript.exe","commandLine":"\\\"C:\\\\Windows\\\\System32\\\\WScript.exe\\\" \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\starter.vbs\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C","parentProcessGuid":"{4dc16835-c189-6089-a003-000000002e00}","parentProcessId":"6876","parentImage":"C:\\\\Windows\\\\System32\\\\cscript.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cscript.exe\\\" .\\\\drop-payloads.vbe"}}} -->
    <rule id="92011" level="6">
        <if_sid>92010</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\\(c|w)script\.exe.+\.(bat|cmd|lnk|pif|vbs|vbe|js|wsh|ps1)</field>
        <description>Scripting interpreter spawned new scripting interpreter</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.5366909Z","eventRecordID":"144512","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-04-28 20:11:55.529\r\nProcessGuid: {4dc16835-c18b-6089-a303-000000002e00}\r\nProcessId: 5256\r\nImage: C:\\Windows\\System32\\cmd.exe\r\nFileVersion: 10.0.19041.746 (WinBuild.160101.0800)\r\nDescription: Windows Command Processor\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: Cmd.Exe\r\nCommandLine: \"C:\\Windows\\System32\\cmd.exe\" /k wscript.exe \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18\r\nParentProcessGuid: {4dc16835-c18b-6089-a203-000000002e00}\r\nParentProcessId: 648\r\nParentImage: C:\\Windows\\System32\\wscript.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\TransbaseOdbcDriver\\starter.vbs\" \""},"eventdata":{"ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","utcTime":"2021-04-28 20:11:55.529","processGuid":"{4dc16835-c18b-6089-a303-000000002e00}","processId":"5256","image":"C:\\\\Windows\\\\System32\\\\cmd.exe","fileVersion":"10.0.19041.746 (WinBuild.160101.0800)","description":"Windows Command Processor","product":"Microsoft® Windows® Operating System","company":"Microsoft Corporation","originalFileName":"Cmd.Exe","commandLine":"\\\"C:\\\\Windows\\\\System32\\\\cmd.exe\\\" /k wscript.exe \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18","parentProcessGuid":"{4dc16835-c18b-6089-a203-000000002e00}","parentProcessId":"648","parentImage":"C:\\\\Windows\\\\System32\\\\wscript.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\WScript.exe\\\" \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\starter.vbs\\\""}}} -->
    <rule id="92012" level="6">
        <if_sid>92010</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">\\cmd\.exe</field>
        <description>Scripting interpreter spawned Windows command shell instance</description>
        <mitre>
            <id>T1059.003</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"image":"C:\\\\Users\\\\Public\\\\Java-Update.exe","parentProcessGuid":"{4dc16835-c209-60f1-b8ad-120000000000}","logonGuid":"{4dc16835-c1eb-60f1-688d-0c0000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\WScript.exe\\\" \\\"C:\\\\Users\\\\Public\\\\Java-Update.vbs\\\"","processGuid":"{4dc16835-c20a-60f1-700e-130000000000}","logonId":"0xc8d68","parentProcessId":"1816","processId":"2376","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-16 17:29:46.687","hashes":"SHA1=28552B021D7B5AAEADB1EFAEF131D27163E14C40,MD5=4E73669498619133E45027923A37D96F,SHA256=E89C55EFD53017B4BD2C9754399D8FF02DE6BC8D1014D8684B75D180381F0EEC,IMPHASH=D9B720999365740321DA784FA1B54067","parentImage":"C:\\\\Windows\\\\System32\\\\wscript.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","commandLine":"\\\"C:\\\\Users\\\\Public\\\\Java-Update.exe\\\"","integrityLevel":"Medium","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-16 17:29:46.687\r\nProcessGuid: {4dc16835-c20a-60f1-700e-130000000000}\r\nProcessId: 2376\r\nImage: C:\\Users\\Public\\Java-Update.exe\r\nFileVersion: -\r\nDescription: -\r\nProduct: -\r\nCompany: -\r\nOriginalFileName: -\r\nCommandLine: \"C:\\Users\\Public\\Java-Update.exe\" \r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-c1eb-60f1-688d-0c0000000000}\r\nLogonId: 0xC8D68\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=28552B021D7B5AAEADB1EFAEF131D27163E14C40,MD5=4E73669498619133E45027923A37D96F,SHA256=E89C55EFD53017B4BD2C9754399D8FF02DE6BC8D1014D8684B75D180381F0EEC,IMPHASH=D9B720999365740321DA784FA1B54067\r\nParentProcessGuid: {4dc16835-c209-60f1-b8ad-120000000000}\r\nParentProcessId: 1816\r\nParentImage: C:\\Windows\\System32\\wscript.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\WScript.exe\" \"C:\\Users\\Public\\Java-Update.vbs\" \"","version":"5","systemTime":"2021-07-16T17:29:46.7996246Z","eventRecordID":"33700","threadID":"2520","computer":"cfo.ExchangeTest.com","task":"1","processID":"2476","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92013" level="6">
        <if_sid>92010</if_sid>
        <field name="win.eventdata.image" type="pcre2">(?i)[c-z]:(\\\\Users\\\\Public\\\\|\\\\Users\\\\.+\\\\AppData\\\\local\\\\temp)</field>
        <description>Scripting interpreter spawned a process from a suspicious path</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"Cmd.Exe","image":"C:\\\\Windows\\\\System32\\\\cmd.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-3136-609c-2c01-000000003b00}","description":"Windows Command Processor","logonGuid":"{4dc16835-2e5f-609c-19a4-7c0000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-3bdd-609c-5901-000000003b00}","logonId":"0x7ca419","parentProcessId":"1488","processId":"5560","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-05-12 20:34:37.091","hashes":"SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\system32\\\\cmd.exe","integrityLevel":"Medium","fileVersion":"10.0.19041.746 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-05-12 20:34:37.091\r\nProcessGuid: {4dc16835-3bdd-609c-5901-000000003b00}\r\nProcessId: 5560\r\nImage: C:\\Windows\\System32\\cmd.exe\r\nFileVersion: 10.0.19041.746 (WinBuild.160101.0800)\r\nDescription: Windows Command Processor\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: Cmd.Exe\r\nCommandLine: C:\\Windows\\system32\\cmd.exe\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-2e5f-609c-19a4-7c0000000000}\r\nLogonId: 0x7CA419\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=F1EFB0FDDC156E4C61C5F78A54700E4E7984D55D,MD5=8A2122E8162DBEF04694B9C3E0B6CDEE,SHA256=B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450,IMPHASH=272245E2988E1E430500B852C4FB5E18\r\nParentProcessGuid: {4dc16835-3136-609c-2c01-000000003b00}\r\nParentProcessId: 1488\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-05-12T20:34:37.0992054Z","eventRecordID":"199321","threadID":"3320","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2080","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92021" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">\\cmd\.exe</field>
        <field name="win.eventdata.parentImage" type="pcre2">(?i)\\powershell\.exe</field>
        <description>Powershell process spawned Windows command shell instance</description>
        <mitre>
            <id>T1059.003</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"system":{"providerName":"Microsoft-Windows-Sysmon","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","eventID":"1","version":"5","level":"4","task":"1","opcode":"0","keywords":"0x8000000000000000","systemTime":"2021-04-28T20:11:55.6337382Z","eventRecordID":"144514","processID":"2204","threadID":"3300","channel":"Microsoft-Windows-Sysmon/Operational","computer":"DESKTOP-2QKFOBA","severityValue":"INFORMATION","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-04-28 20:11:55.619\r\nProcessGuid: {4dc16835-c18b-6089-a503-000000002e00}\r\nProcessId: 2488\r\nImage: C:\\Windows\\System32\\wscript.exe\r\nFileVersion: 5.812.10240.16384\r\nDescription: Microsoft ® Windows Based Script Host\r\nProduct: Microsoft ® Windows Script Host\r\nCompany: Microsoft Corporation\r\nOriginalFileName: wscript.exe\r\nCommandLine: wscript.exe  \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\r\nCurrentDirectory: C:\\Users\\AtomicRedTeamTest\\Downloads\\\r\nUser: DESKTOP-2QKFOBA\\AtomicRedTeamTest\r\nLogonGuid: {4dc16835-596f-6089-d6a0-040000000000}\r\nLogonId: 0x4A0D6\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C\r\nParentProcessGuid: {4dc16835-c18b-6089-a303-000000002e00}\r\nParentProcessId: 5256\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\cmd.exe\" /k wscript.exe \"C:\\Users\\AtomicRedTeamTest\\AppData\\Roaming\\\\TransBaseOdbcDriver\\\\TransBaseOdbcDriver.js\"\""},"eventdata":{"ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","utcTime":"2021-04-28 20:11:55.619","processGuid":"{4dc16835-c18b-6089-a503-000000002e00}","processId":"2488","image":"C:\\\\Windows\\\\System32\\\\wscript.exe","fileVersion":"5.812.10240.16384","description":"Microsoft ® Windows Based Script Host","product":"Microsoft ® Windows Script Host","company":"Microsoft Corporation","originalFileName":"wscript.exe","commandLine":"wscript.exe  \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\"","currentDirectory":"C:\\\\Users\\\\AtomicRedTeamTest\\\\Downloads\\\\","user":"DESKTOP-2QKFOBA\\\\AtomicRedTeamTest","logonGuid":"{4dc16835-596f-6089-d6a0-040000000000}","logonId":"0x4a0d6","terminalSessionId":"1","integrityLevel":"High","hashes":"SHA1=545EC11DEE642DE633EB2C6F6FFC90CCE4DECF8D,MD5=0639B0A6F69B3265C1E42227D650B7D1,SHA256=CE9F70E104C07D92FC05FBD6000839FD6A87FF010E706396F87DD679244ED97B,IMPHASH=0F71D5F6F4CBB935CE1B09754102419C","parentProcessGuid":"{4dc16835-c18b-6089-a303-000000002e00}","parentProcessId":"5256","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\cmd.exe\\\" /k wscript.exe \\\"C:\\\\Users\\\\AtomicRedTeamTest\\\\AppData\\\\Roaming\\\\\\\\TransBaseOdbcDriver\\\\\\\\TransBaseOdbcDriver.js\\\""}}}-->
    <rule id="92030" level="4">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\\(c|w)script\.exe.+[c-z]:\\(Windows\\Temp)|Users\\.+\.(bat|cmd|lnk|pif|vbs|vbe|js|wsh|ps1)</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)cmd\.exe.+/(c|k)</field>
        <description>Command shell started script with /c modifier</description>
        <mitre>
            <id>T1059</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"csc.exe","image":"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe","product":"Microsoft® .NET Framework","parentProcessGuid":"{4dc16835-5bcf-6091-b801-000000003500}","description":"Visual C# Command Line Compiler","logonGuid":"{4dc16835-5948-6091-2f18-2d0000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-5bd1-6091-b901-000000003500}","logonId":"0x2d182f","parentProcessId":"5912","processId":"5124","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-05-04 14:36:01.555","hashes":"SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution","company":"Microsoft Corporation","commandLine":"\\\"C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\csc.exe\\\" /noconfig /fullpaths @\\\"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Local\\\\Temp\\\\bspmrlpb.cmdline\\\"","integrityLevel":"Medium","fileVersion":"4.8.4084.0 built by: NET48REL1","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1127,technique_name=Trusted Developer Utilities Proxy Execution\r\nUtcTime: 2021-05-04 14:36:01.555\r\nProcessGuid: {4dc16835-5bd1-6091-b901-000000003500}\r\nProcessId: 5124\r\nImage: C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\r\nFileVersion: 4.8.4084.0 built by: NET48REL1\r\nDescription: Visual C# Command Line Compiler\r\nProduct: Microsoft® .NET Framework\r\nCompany: Microsoft Corporation\r\nOriginalFileName: csc.exe\r\nCommandLine: \"C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe\" /noconfig /fullpaths @\"C:\\Users\\AtomicRed\\AppData\\Local\\Temp\\bspmrlpb.cmdline\"\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-5948-6091-2f18-2d0000000000}\r\nLogonId: 0x2D182F\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=528973416456C780051889CA1709510B6BF73370,MD5=F65B029562077B648A6A5F6A1AA76A66,SHA256=4A6D0864E19C0368A47217C129B075DDDF61A6A262388F9D21045D82F3423ED7,IMPHASH=EE1E569AD02AA1F7AECA80AC0601D80D\r\nParentProcessGuid: {4dc16835-5bcf-6091-b801-000000003500}\r\nParentProcessId: 5912\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-05-04T14:36:01.5571724Z","eventRecordID":"168729","threadID":"3100","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2432","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92050" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image" type="pcre2">(?i)\\csc\.exe</field>
        <field name="win.eventdata.parentCommandLine" type="pcre2">(?i)powershell.+ExecutionPolicy\s+bypass</field>
        <description>Powershell script compiling code using CSC.exe, possible malware drop</description>
        <mitre>
            <id>T1027.004</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-5ce5-60e3-3601-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5368","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:26:29.887","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:26:29.887\r\nProcessGuid: {4dc16835-5ce5-60e3-3601-000000004800}\r\nProcessId: 5368\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:26:29.8895020Z","eventRecordID":"252295","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92051" level="3">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.image" type="pcre2">(?i)\\powershell\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)Set-MpPreference</field>
        <description>Possible tampering on Windows Defender configuration by Powershell command</description>
        <mitre>
            <id>T1562</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-5ce5-60e3-3601-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5368","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:26:29.887","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:26:29.887\r\nProcessGuid: {4dc16835-5ce5-60e3-3601-000000004800}\r\nProcessId: 5368\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -disableRealtimeMonitoring $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:26:29.8895020Z","eventRecordID":"252295","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92052" level="12">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableRealtimeMonitoring|drtm)\s+(\$true|1)</field>
        <description>Windows Defender real time monitoring was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>


    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-604e-60e3-4e01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3668","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:41:02.965","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableIntrusionPreventionSystem $True","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:41:02.965\r\nProcessGuid: {4dc16835-604e-60e3-4e01-000000004800}\r\nProcessId: 3668\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableIntrusionPreventionSystem $True -drtm $True\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:41:02.9670466Z","eventRecordID":"252585","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92053" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableIntrusionPreventionSystem|dips)\s+(\$true|1)</field>
        <description>Windows Defender Intrusion prevention system was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6122-60e3-5501-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"2412","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:44:34.850","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableIOAVProtection $true","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:44:34.850\r\nProcessGuid: {4dc16835-6122-60e3-5501-000000004800}\r\nProcessId: 2412\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableIOAVProtection $true\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:44:34.8524432Z","eventRecordID":"252663","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92054" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableIOAVProtection|dioavp)\s+(\$true|1)</field>
        <description>Windows Defender downloaded file scanning was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6241-60e3-5701-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3932","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:49:21.722","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -DisableScriptScanning $true","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:49:21.722\r\nProcessGuid: {4dc16835-6241-60e3-5701-000000004800}\r\nProcessId: 3932\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -DisableScriptScanning $true\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:49:21.7244621Z","eventRecordID":"252777","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92055" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(DisableScriptScanning|dscrptsc)\s+(\$true|1)</field>
        <description>Windows Defender script scanning was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-64a3-60e3-6901-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"4880","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 19:59:31.139","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -EnableControlledFolderAccess Disabled","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 19:59:31.139\r\nProcessGuid: {4dc16835-64a3-60e3-6901-000000004800}\r\nProcessId: 4880\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -EnableControlledFolderAccess Disabled\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T19:59:31.1448035Z","eventRecordID":"253037","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92056" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)EnableControlledFolderAccess\s+(disabled|AuditMode)</field>
        <description>Windows Defender Controlled folder access was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6568-60e3-6a01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"1480","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:02:48.537","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -EnableNetworkProtection AuditMode","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:02:48.537\r\nProcessGuid: {4dc16835-6568-60e3-6a01-000000004800}\r\nProcessId: 1480\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -EnableNetworkProtection AuditMode\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:02:48.5392839Z","eventRecordID":"253061","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92057" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)EnableNetworkProtection\s+(disabled|AuditMode)</field>
        <description>Windows Defender network protection was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-65f7-60e3-6c01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"5996","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:05:11.183","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe  Set-MpPreference -MAPSReporting Disabled","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:05:11.183\r\nProcessGuid: {4dc16835-65f7-60e3-6c01-000000004800}\r\nProcessId: 5996\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  Set-MpPreference -MAPSReporting Disabled\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:05:11.1856889Z","eventRecordID":"253083","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92058" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)MAPSReporting\s+(disabled|AuditMode)</field>
        <description>Microsoft Active Protection Service (MAPS) was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Windows PowerShell","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-66cb-60e3-7101-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"1492","currentDirectory":"C:\\\\Windows\\\\system32\\\\","utcTime":"2021-07-05 20:08:43.978","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.001,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe Set-MpPreference  -SubmitSamplesConsent NeverSend","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.001,technique_name=PowerShell\r\nUtcTime: 2021-07-05 20:08:43.978\r\nProcessGuid: {4dc16835-66cb-60e3-7101-000000004800}\r\nProcessId: 1492\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe  -SubmitSamplesConsent NeverSend\r\nCurrentDirectory: C:\\Windows\\system32\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:08:43.9804703Z","eventRecordID":"253147","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92059" level="13">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)SubmitSamplesConsent\s+NeverSend</field>
        <description>Windows Defender sample submit was disabled by Powershell command</description>
        <mitre>
            <id>T1562.001</id>
        </mitre>
    </rule>


    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\cert.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92060" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)CertUtil\.exe</field>
        <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)CertUtil\.exe</field>
        <description>Masqueraded CertUtil.exe with a different file name. Possible use to decode malware</description>
        <mitre>
            <id>T1036.003</id>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\cert.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe  -decode c:\\\\x\\\\peer.crt c:\\\\x\\\\agent.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92061" level="13">
        <if_sid>92060</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)decode\s+(.+)\s+.+\.exe</field>
        <description>Masqueraded CertUtil.exe used to decode binary file</description>
        <mitre>
            <id>T1036.003</id>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"CertUtil.exe","image":"C:\\\\Windows\\\\certutil.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"CertUtil.exe","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-6c17-60e3-8f01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"3960","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:31:19.061","hashes":"SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1202,technique_name=Indirect Command Execution","company":"Microsoft Corporation","commandLine":"C:\\\\Windows\\\\cert.exe  -decode c:\\\\x\\\\peer.crt c:\\\\x\\\\agent.exe","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1202,technique_name=Indirect Command Execution\r\nUtcTime: 2021-07-05 20:31:19.061\r\nProcessGuid: {4dc16835-6c17-60e3-8f01-000000004800}\r\nProcessId: 3960\r\nImage: C:\\Windows\\cert.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: CertUtil.exe\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: CertUtil.exe\r\nCommandLine: C:\\Windows\\cert.exe  -decode c:\\x\\peer.crt c:\\x\\agent.exe\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=ED314BE18A50107B404681FA5FD74B6B17109CBE,MD5=AB8F510E2A9B9F932A6AB1BBA4E73ED9,SHA256=97DB9285A916F00B0C8149C7B36438726E227C5DD26E874037734C23B50066DC,IMPHASH=7B7F7ED372C027216AE5100589C424EA\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:31:19.0634236Z","eventRecordID":"253469","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92062" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)CertUtil\.exe</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)decode\s+(.+)\s+.+\.exe</field>
        <description>CertUtil.exe used to decode binary file</description>
        <mitre>
            <id>T1140</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"MsMpEng.exe","image":"C:\\\\Windows\\\\MsMpEng.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-5b4e-60e3-1b01-000000004800}","description":"Antimalware Service Executable","logonGuid":"{4dc16835-599e-60e3-ad77-240000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-68de-60e3-7d01-000000004800}","logonId":"0x2477ad","parentProcessId":"5616","processId":"4304","currentDirectory":"C:\\\\Windows\\\\","utcTime":"2021-07-05 20:17:34.077","hashes":"SHA1=85536AD6AFEE43B728ED12EE8CFFCA41F74F6446,MD5=CA2DE21D04A42228B707ABCE64EBBC8B,SHA256=2CCB6063389F3512BE2EF169E236C7474380C542ABD82B4B6BCAA8DEE2E3DCBE,IMPHASH=E568A0358C31B8910DC7FFF649D3FE0D","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Microsoft Corporation","commandLine":"msmpeng","integrityLevel":"High","fileVersion":"4.18.1909.6 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-07-05 20:17:34.077\r\nProcessGuid: {4dc16835-68de-60e3-7d01-000000004800}\r\nProcessId: 4304\r\nImage: C:\\Windows\\MsMpEng.exe\r\nFileVersion: 4.18.1909.6 (WinBuild.160101.0800)\r\nDescription: Antimalware Service Executable\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: MsMpEng.exe\r\nCommandLine: msmpeng\r\nCurrentDirectory: C:\\Windows\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-599e-60e3-ad77-240000000000}\r\nLogonId: 0x2477AD\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=85536AD6AFEE43B728ED12EE8CFFCA41F74F6446,MD5=CA2DE21D04A42228B707ABCE64EBBC8B,SHA256=2CCB6063389F3512BE2EF169E236C7474380C542ABD82B4B6BCAA8DEE2E3DCBE,IMPHASH=E568A0358C31B8910DC7FFF649D3FE0D\r\nParentProcessGuid: {4dc16835-5b4e-60e3-1b01-000000004800}\r\nParentProcessId: 5616\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-05T20:17:34.0803610Z","eventRecordID":"253242","threadID":"3184","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2184","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}}-->
    <rule id="92063" level="13">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)MsMpEng\.exe</field>
        <field name="win.eventdata.image" type="pcre2" negate="yes">(?i)[c-z]:\\\\(ProgramData\\\\Microsoft|Program Files)\\\\Windows Defender</field>
        <description>Windows Defender executed from suspicious path, possible DLL side-loading</description>
        <mitre>
            <id>T1574.002</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"qwinsta.exe","image":"C:\\\\Windows\\\\System32\\\\qwinsta.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{86107A5D-799F-60E7-7DC7-150100000000}","description":"Query Session Utility","logonGuid":"{86107A5D-76D7-60E7-8BFB-390000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\\\"","processGuid":"{86107A5D-7C05-60E7-F289-D00100000000}","logonId":"0x39fb8b","parentProcessId":"6272","processId":"7808","currentDirectory":"C:\\\\Users\\\\Administrator\\\\","utcTime":"2021-07-08 22:28:21.470","hashes":"SHA1=FA14C6ED7BF22CD174D95642DC2C58105299BE1D,MD5=D36DBFEBFDF8580FD6A3945548DC2208,SHA256=4E4F3651C108BB2D3B660DC1FE492373EAC23BC9D4C79B2D65521D03732797C0,IMPHASH=374BAB87D27C0874C5C374A1D2C1F399","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1086,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"\\\"C:\\\\Windows\\\\system32\\\\qwinsta.exe\\\" /server:hrmanager","integrityLevel":"High","fileVersion":"10.0.14393.0 (rs1_release.160715-1616)","user":"EXCHANGETEST\\\\Administrator","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385F-C22A-43E0-BF4C-06F5698FFBD9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1086,technique_name=PowerShell\r\nUtcTime: 2021-07-08 22:28:21.470\r\nProcessGuid: {86107A5D-7C05-60E7-F289-D00100000000}\r\nProcessId: 7808\r\nImage: C:\\Windows\\System32\\qwinsta.exe\r\nFileVersion: 10.0.14393.0 (rs1_release.160715-1616)\r\nDescription: Query Session Utility\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: qwinsta.exe\r\nCommandLine: \"C:\\Windows\\system32\\qwinsta.exe\" /server:hrmanager\r\nCurrentDirectory: C:\\Users\\Administrator\\\r\nUser: EXCHANGETEST\\Administrator\r\nLogonGuid: {86107A5D-76D7-60E7-8BFB-390000000000}\r\nLogonId: 0x39FB8B\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=FA14C6ED7BF22CD174D95642DC2C58105299BE1D,MD5=D36DBFEBFDF8580FD6A3945548DC2208,SHA256=4E4F3651C108BB2D3B660DC1FE492373EAC23BC9D4C79B2D65521D03732797C0,IMPHASH=374BAB87D27C0874C5C374A1D2C1F399\r\nParentProcessGuid: {86107A5D-799F-60E7-7DC7-150100000000}\r\nParentProcessId: 6272\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: \"C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\" \"","version":"5","systemTime":"2021-07-08T22:28:21.473279400Z","eventRecordID":"1280040","threadID":"4028","computer":"bankdc.ExchangeTest.com","task":"1","processID":"2664","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92115" level="3">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">qwinsta</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\/server</field>
        <description>Gathered user information from Remote Desktop Service sessions</description>
        <mitre>
            <id>T1033</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"subjectLogonId":"0x3e7","restrictedAdminMode":"%%1843","subjectDomainName":"EXCHANGETEST","targetLinkedLogonId":"0x0","impersonationLevel":"%%1833","ipAddress":"::1","authenticationPackageName":"Negotiate","workstationName":"BANKDC","targetLogonId":"0x4105aff","logonProcessName":"User32","logonGuid":"{64C35E00-1827-0FCE-2AE0-11E54FFE301F}","targetUserName":"Administrator","keyLength":"0","elevatedToken":"%%1842","subjectUserSid":"S-1-5-18","processId":"0x464","processName":"C:\\\\Windows\\\\System32\\\\svchost.exe","ipPort":"0","targetDomainName":"EXCHANGETEST","targetUserSid":"S-1-5-21-887924094-598891991-956377308-500","virtualAccount":"%%1843","logonType":"10","subjectUserName":"BANKDC$"},"system":{"eventID":"4624","keywords":"0x8020000000000000","providerGuid":"{54849625-5478-4994-A5BA-3E3B0328C30D}","level":"0","channel":"Security","opcode":"0","message":"\"An account was successfully logged on.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-18\r\n\tAccount Name:\t\tBANKDC$\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x3E7\r\n\r\nLogon Information:\r\n\tLogon Type:\t\t10\r\n\tRestricted Admin Mode:\tNo\r\n\tVirtual Account:\t\tNo\r\n\tElevated Token:\t\tYes\r\n\r\nImpersonation Level:\t\tImpersonation\r\n\r\nNew Logon:\r\n\tSecurity ID:\t\tS-1-5-21-887924094-598891991-956377308-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tEXCHANGETEST\r\n\tLogon ID:\t\t0x4105AFF\r\n\tLinked Logon ID:\t\t0x0\r\n\tNetwork Account Name:\t-\r\n\tNetwork Account Domain:\t-\r\n\tLogon GUID:\t\t{64C35E00-1827-0FCE-2AE0-11E54FFE301F}\r\n\r\nProcess Information:\r\n\tProcess ID:\t\t0x464\r\n\tProcess Name:\t\tC:\\Windows\\System32\\svchost.exe\r\n\r\nNetwork Information:\r\n\tWorkstation Name:\tBANKDC\r\n\tSource Network Address:\t::1\r\n\tSource Port:\t\t0\r\n\r\nDetailed Authentication Information:\r\n\tLogon Process:\t\tUser32 \r\n\tAuthentication Package:\tNegotiate\r\n\tTransited Services:\t-\r\n\tPackage Name (NTLM only):\t-\r\n\tKey Length:\t\t0\r\n\r\nThis event is generated when a logon session is created. It is generated on the computer that was accessed.\r\n\r\nThe subject fields indicate the account on the local system which requested the logon. This is most commonly a service such as the Server service, or a local process such as Winlogon.exe or Services.exe.\r\n\r\nThe logon type field indicates the kind of logon that occurred. The most common types are 2 (interactive) and 3 (network).\r\n\r\nThe New Logon fields indicate the account for whom the new logon was created, i.e. the account that was logged on.\r\n\r\nThe network fields indicate where a remote logon request originated. Workstation name is not always available and may be left blank in some cases.\r\n\r\nThe impersonation level field indicates the extent to which a process in the logon session can impersonate.\r\n\r\nThe authentication information fields provide detailed information about this specific logon request.\r\n\t- Logon GUID is a unique identifier that can be used to correlate this event with a KDC event.\r\n\t- Transited services indicate which intermediate services have participated in this logon request.\r\n\t- Package name indicates which sub-protocol was used among the NTLM protocols.\r\n\t- Key length indicates the length of the generated session key. This will be 0 if no session key was requested.\"","version":"2","systemTime":"2021-07-02T20:19:32.631853500Z","eventRecordID":"4200219","threadID":"720","computer":"bankdc.ExchangeTest.com","task":"12544","processID":"556","severityValue":"AUDIT_SUCCESS","providerName":"Microsoft-Windows-Security-Auditing"}}} -->
    <rule id="92065" level="15">
        <if_sid>92051</if_sid>
        <field name="win.eventdata.ipAddress" type="pcre2">::1|127\.0\.0\.1</field>
        <description>User: $(win.eventdata.subjectDomainName)\$(win.eventdata.targetUserName) logged using Remote Desktop Connection (RDP) from loopback address, possible exploit over reverse tunneling using stolen credentials</description>
        <mitre>
            <id>T1021.001</id>
            <id>T1078.002</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PSCP","image":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\pscp.exe","product":"PuTTY suite","parentProcessGuid":"{4dc16835-3bdd-609c-5901-000000003b00}","description":"Command-line SCP/SFTP client","logonGuid":"{4dc16835-2e5f-609c-19a4-7c0000000000}","parentCommandLine":"C:\\\\Windows\\\\system32\\\\cmd.exe","processGuid":"{4dc16835-416a-609c-7601-000000003b00}","logonId":"0x7ca419","parentProcessId":"5560","processId":"2180","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\AppData\\\\Roaming\\\\TransbaseOdbcDriver\\\\","utcTime":"2021-05-12 20:58:18.149","hashes":"SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1059.003,technique_name=Windows Command Shell","company":"Simon Tatham","commandLine":"pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py","integrityLevel":"Medium","fileVersion":"Release 0.73","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1059.003,technique_name=Windows Command Shell\r\nUtcTime: 2021-05-12 20:58:18.149\r\nProcessGuid: {4dc16835-416a-609c-7601-000000003b00}\r\nProcessId: 2180\r\nImage: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\pscp.exe\r\nFileVersion: Release 0.73\r\nDescription: Command-line SCP/SFTP client\r\nProduct: PuTTY suite\r\nCompany: Simon Tatham\r\nOriginalFileName: PSCP\r\nCommandLine: pscp.exe  -scp psexec.py administrator@Exchangetest.com@192.168.0.218:/tmp/psexec.py\r\nCurrentDirectory: C:\\Users\\AtomicRed\\AppData\\Roaming\\TransbaseOdbcDriver\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-2e5f-609c-19a4-7c0000000000}\r\nLogonId: 0x7CA419\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=EE1B5F3A7F9563A9E7575EDDA467794584555F97,MD5=3145D4A197A3523253880E9E6E76F798,SHA256=7A09FD6885CA5662A40D6F9212C115D8F38C88F9C1BCDA697854BFB202F289B2,IMPHASH=C2612378E2F461D6FCF8743722ABEB7A\r\nParentProcessGuid: {4dc16835-3bdd-609c-5901-000000003b00}\r\nParentProcessId: 5560\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: C:\\Windows\\system32\\cmd.exe\"","version":"5","systemTime":"2021-05-12T20:58:18.1529188Z","eventRecordID":"199658","threadID":"3320","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2080","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92105" level="6">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">PSCP</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)-scp</field>
        <description>A file was copied to other system over SSH using pscp.exe</description>
        <mitre>
            <id>T1021.004</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-1eb6-60f7-99b1-260000000000}","description":"Windows PowerShell","logonGuid":"{4dc16835-1d4f-60f7-39ca-130000000000}","parentCommandLine":"powershell  -ExecutionPolicy Bypass -NoExit .\\\\meta.ps1","processGuid":"{4dc16835-2c0a-60f7-46c4-570000000000}","logonId":"0x13ca39","parentProcessId":"6056","processId":"3328","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\","utcTime":"2021-07-20 20:03:22.083","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","ruleName":"technique_id=T1086,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"powershell.exe -c Remove-Item $env:TEMP\\\\* -Recurse -Force -Erroraction 'silentlycontinue'","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1086,technique_name=PowerShell\r\nUtcTime: 2021-07-20 20:03:22.083\r\nProcessGuid: {4dc16835-2c0a-60f7-46c4-570000000000}\r\nProcessId: 3328\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: powershell.exe -c Remove-Item $env:TEMP\\* -Recurse -Force -Erroraction 'silentlycontinue'\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-1d4f-60f7-39ca-130000000000}\r\nLogonId: 0x13CA39\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-1eb6-60f7-99b1-260000000000}\r\nParentProcessId: 6056\r\nParentImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nParentCommandLine: powershell  -ExecutionPolicy Bypass -NoExit .\\meta.ps1\"","version":"5","systemTime":"2021-07-20T20:03:22.0909717Z","eventRecordID":"279401","threadID":"3248","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2392","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92110" level="0">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)PowerShell\.EXE</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)(Remove-Item|ri|rm|rmdir|del|erase|rd)\b</field>
        <description>Powershell was used to delete files or directories</description>
        <mitre>
            <id>T107.004</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-6ce9-60f8-2605-580000000000}","description":"Windows PowerShell","logonGuid":"{4dc16835-577d-60f8-9e02-1b0000000000}","parentCommandLine":"ShadowSteal.exe","processGuid":"{4dc16835-6ce9-60f8-f206-580000000000}","logonId":"0x1b029e","parentProcessId":"4252","processId":"3316","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\shadow2\\\\","utcTime":"2021-07-21 18:52:25.041","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\shadow2\\\\ShadowSteal.exe","ruleName":"technique_id=T1086,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"powershell.exe -c \\\"[System.IO.File]::Exists('\\\\\\\\?\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy1\\\\Windows\\\\System32\\\\config\\\\SAM')\\\"","integrityLevel":"Medium","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1086,technique_name=PowerShell\r\nUtcTime: 2021-07-21 18:52:25.041\r\nProcessGuid: {4dc16835-6ce9-60f8-f206-580000000000}\r\nProcessId: 3316\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: powershell.exe -c \"[System.IO.File]::Exists('\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SAM')\"\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\shadow2\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-577d-60f8-9e02-1b0000000000}\r\nLogonId: 0x1B029E\r\nTerminalSessionId: 1\r\nIntegrityLevel: Medium\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-6ce9-60f8-2605-580000000000}\r\nParentProcessId: 4252\r\nParentImage: C:\\Users\\AtomicRed\\Downloads\\shadow2\\ShadowSteal.exe\r\nParentCommandLine: ShadowSteal.exe\"","version":"5","systemTime":"2021-07-21T18:52:25.0482836Z","eventRecordID":"296247","threadID":"3460","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2428","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92120" level="8">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)PowerShell.EXE</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\\\\HarddiskVolumeShadowCopy.+\\\\(SAM|SECURITY)</field>
        <description>Suspicious Powershell activity with VSS and Windows SAM hive</description>
        <mitre>
            <id>T1003.002</id>
            <id>T1059.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"PowerShell.EXE","image":"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-6d03-60f8-3101-000000005300}","description":"Windows PowerShell","logonGuid":"{4dc16835-577d-60f8-7c02-1b0000000000}","parentCommandLine":"ShadowSteal.exe","processGuid":"{4dc16835-6d03-60f8-fd83-590000000000}","logonId":"0x1b027c","parentProcessId":"4832","processId":"4636","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\shadow2\\\\","utcTime":"2021-07-21 18:52:51.728","hashes":"SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7","parentImage":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\shadow2\\\\ShadowSteal.exe","ruleName":"technique_id=T1086,technique_name=PowerShell","company":"Microsoft Corporation","commandLine":"powershell.exe -c \\\"[System.IO.File]::Copy('\\\\\\\\?\\\\GLOBALROOT\\\\Device\\\\HarddiskVolumeShadowCopy1\\\\Windows\\\\System32\\\\config\\\\SECURITY', 'tmp\\\\202107211152_SECURITY')\\\"","integrityLevel":"High","fileVersion":"10.0.19041.546 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1086,technique_name=PowerShell\r\nUtcTime: 2021-07-21 18:52:51.728\r\nProcessGuid: {4dc16835-6d03-60f8-fd83-590000000000}\r\nProcessId: 4636\r\nImage: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\r\nFileVersion: 10.0.19041.546 (WinBuild.160101.0800)\r\nDescription: Windows PowerShell\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: PowerShell.EXE\r\nCommandLine: powershell.exe -c \"[System.IO.File]::Copy('\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\Windows\\System32\\config\\SECURITY', 'tmp\\202107211152_SECURITY')\"\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\shadow2\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-577d-60f8-7c02-1b0000000000}\r\nLogonId: 0x1B027C\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=F43D9BB316E30AE1A3494AC5B0624F6BEA1BF054,MD5=04029E121A0CFA5991749937DD22A1D9,SHA256=9F914D42706FE215501044ACD85A32D58AAEF1419D404FDDFA5D3B48F66CCD9F,IMPHASH=7C955A0ABC747F57CCC4324480737EF7\r\nParentProcessGuid: {4dc16835-6d03-60f8-3101-000000005300}\r\nParentProcessId: 4832\r\nParentImage: C:\\Users\\AtomicRed\\Downloads\\shadow2\\ShadowSteal.exe\r\nParentCommandLine: ShadowSteal.exe\"","version":"5","systemTime":"2021-07-21T18:52:51.7297548Z","eventRecordID":"296414","threadID":"3460","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2428","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92121" level="14">
        <if_sid>92120</if_sid>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)\[System.IO.File\]::Copy</field>
        <description>Powershell used to copy SAM hive from VSS</description>
        <mitre>
            <id>T1003.002</id>
            <id>T1059.001</id>
        </mitre>
    </rule>

    <!-- Sample: {"win":{"eventdata":{"originalFileName":"reg.exe","image":"C:\\\\Windows\\\\System32\\\\reg.exe","product":"Microsoft® Windows® Operating System","parentProcessGuid":"{4dc16835-57e4-60f8-f782-260000000000}","description":"Registry Console Tool","logonGuid":"{4dc16835-577d-60f8-7c02-1b0000000000}","parentCommandLine":"\\\"C:\\\\Windows\\\\system32\\\\cmd.exe\\\"","processGuid":"{4dc16835-795e-60f8-c58a-770000000000}","logonId":"0x1b027c","parentProcessId":"5488","processId":"4616","currentDirectory":"C:\\\\Users\\\\AtomicRed\\\\Downloads\\\\shadow2\\\\","utcTime":"2021-07-21 19:45:34.763","hashes":"SHA1=C0DB341DEFA8EF40C03ED769A9001D600E0F4DAE,MD5=227F63E1D9008B36BDBCC4B397780BE4,SHA256=C0E25B1F9B22DE445298C1E96DDFCEAD265CA030FA6626F61A4A4786CC4A3B7D,IMPHASH=BE482BE427FE212CFEF2CDA0E61F19AC","parentImage":"C:\\\\Windows\\\\System32\\\\cmd.exe","ruleName":"technique_id=T1112,technique_name=Modify Registry","company":"Microsoft Corporation","commandLine":"reg  save HKLM\\\\sam C:\\\\Users\\\\ATOMIC~2\\\\AppData\\\\Local\\\\Temp\\\\sam","integrityLevel":"High","fileVersion":"10.0.19041.1 (WinBuild.160101.0800)","user":"EXCHANGETEST\\\\AtomicRed","terminalSessionId":"1"},"system":{"eventID":"1","keywords":"0x8000000000000000","providerGuid":"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}","level":"4","channel":"Microsoft-Windows-Sysmon/Operational","opcode":"0","message":"\"Process Create:\r\nRuleName: technique_id=T1112,technique_name=Modify Registry\r\nUtcTime: 2021-07-21 19:45:34.763\r\nProcessGuid: {4dc16835-795e-60f8-c58a-770000000000}\r\nProcessId: 4616\r\nImage: C:\\Windows\\System32\\reg.exe\r\nFileVersion: 10.0.19041.1 (WinBuild.160101.0800)\r\nDescription: Registry Console Tool\r\nProduct: Microsoft® Windows® Operating System\r\nCompany: Microsoft Corporation\r\nOriginalFileName: reg.exe\r\nCommandLine: reg  save HKLM\\sam C:\\Users\\ATOMIC~2\\AppData\\Local\\Temp\\sam\r\nCurrentDirectory: C:\\Users\\AtomicRed\\Downloads\\shadow2\\\r\nUser: EXCHANGETEST\\AtomicRed\r\nLogonGuid: {4dc16835-577d-60f8-7c02-1b0000000000}\r\nLogonId: 0x1B027C\r\nTerminalSessionId: 1\r\nIntegrityLevel: High\r\nHashes: SHA1=C0DB341DEFA8EF40C03ED769A9001D600E0F4DAE,MD5=227F63E1D9008B36BDBCC4B397780BE4,SHA256=C0E25B1F9B22DE445298C1E96DDFCEAD265CA030FA6626F61A4A4786CC4A3B7D,IMPHASH=BE482BE427FE212CFEF2CDA0E61F19AC\r\nParentProcessGuid: {4dc16835-57e4-60f8-f782-260000000000}\r\nParentProcessId: 5488\r\nParentImage: C:\\Windows\\System32\\cmd.exe\r\nParentCommandLine: \"C:\\Windows\\system32\\cmd.exe\" \"","version":"5","systemTime":"2021-07-21T19:45:34.7662294Z","eventRecordID":"298155","threadID":"3460","computer":"hrmanager.ExchangeTest.com","task":"1","processID":"2428","severityValue":"INFORMATION","providerName":"Microsoft-Windows-Sysmon"}}} -->
    <rule id="92130" level="14">
        <if_group>sysmon_event1</if_group>
        <field name="win.eventdata.originalFileName" type="pcre2">(?i)reg.EXE</field>
        <field name="win.eventdata.commandLine" type="pcre2">(?i)save.+\\\\SAM</field>
        <description>Reg.exe used to dump SAM hive</description>
        <mitre>
            <id>T1003.002</id>
        </mitre>
    </rule>


</group>